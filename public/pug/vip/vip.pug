doctype html
html
    title(id="pageTitle") Midback - VIP
    include ../templades/head.pug
    style(id="fontStyle")
    include ../templades/themeChecker.pug

    body(class="theme-templade" style=(styleTheme))
        if (!vip)
            include ../templades/adsContent.pug
        include ../templades/header.pug

        section
            div(class="container")
                input(type="hidden" id="bridgePath" value=(bdgePath))

                div(class="mt-5 mb-5 text-gray" style="word-break: break-all;")
                    h2(class="font-weight-bold") KEY VIP
                    div Tired of the same old advertisements or the Passport screen that appears more than files on the site. Get Midback VIP Access now and get rid of all that headache.
                    div As a way to help, Midback provided daily goals. When the amount of files is reached, the system generates a free KEY VIP as a form of thanks for the effort and dedication in posting files.
                    div When activated, your KEY is unique, but you can share it with whoever you want, THE POWER IS IN YOU!. By default your KEY has an expiration date of 1 month after the creation period.
                    div (Note: Keys generated by File Goals expire in 3 days after the creation period)
                    div What are you waiting for? Get your KEY VIP now and help Midback grow

                div(class="d-flex justify-content-center")
                    ul
                        h6(class="font-weight-bold") VIP Advantages
                        div(class="pl-4 pr-4 pt-2")
                            li Skip Passport Screen
                            li Removal of all ads from the site
                            li Exclusive VIP Board (Coming Soon)
                            li VIP tag next to the file name

                    form(action=(bdgePath + "/vip/assign") method="POST" enctype="multipart/form-data" class="vip-form w-100")
                        label(for="vipKey") Activate VIP key
                        div(class="input-group")
                            input(class="form-control"  placeholder="Type your exclusive VIP key" name="key" id="vipKey")
                            if (admin)
                                button(class="btn btn-danger ml-2 mr-1" id="btnGenerateKey") Generate
                            button(class="btn btn-success ml-2 mr-2") Activate

                        h6(class="mt-2") Do you need another type of key? Support Midback and get unique keys
                        a(target="_blank" href="https://www.patreon.com/dyoniso")
                            img(class="patreon-button" src=(bdgePath + "/assets/support_me.png"))
                        
                            

                if (admin)
                    div(class="key-list")
                        h4(class="text-success text-center" id="keyInfo")
                        h2 Keys Avaiable
                        div(class="key-container" id="keyContainer")
                            each k in keys
                                div(class="key-content" id="key-"+k.id data-id=(k.id))
                                    span [!{`<strong>${k.id}</strong>`}]: #{k.date} ~ #{k.expiresFormat} | Key: !{`<a href="${bdgePath}/vip?activate=${k.key}" class="text-warning">${k.key}</a>`} | Activations: #{k.activate_count} 
                                    span(class="ml-auto btn-close btnDelete") X

        include ../templades/fotter.pug
        if (!vip)
            include ../templades/adsContent.pug       

        script(src=(bdgePath + "/js/fonts.js")) 

        if (admin)
            script.
                $(document).ready((e) => {
                    let bridgePath = $('#bridgePath').val()
                    const shParams = new URLSearchParams(location.search)
                    let adminPassword = shParams.has('pass') ? shParams.get('pass') : ''

                    $('#btnGenerateKey').on('click', (e) => {
                        e.preventDefault()
                        $('#btnGenerateKey').prop('disabled', true)

                        fetch(`${bridgePath}/vip/generate`, {
                            method: 'PUT',
                            headers: { 'Content-Type' : 'application/json' },
                            body: JSON.stringify({ adminPassword : adminPassword })
                        })
                        .then(async(res) => {
                            if (res && res.status === 200) {
                                let data = await res.json()
                                let el = $('#keyInfo')

                                let message = `- Key <span class="text-warning">${data.key}</span> successful created! -`
                                el.addClass('text-success').html(message)
                                $('#btnGenerateKey').prop('disabled', false)

                            } else {
                                $('#keyInfo').addClass('text-danger').text(`- Error after created Key. Status code [${res.status}] -`)
                            }
                        })
                    })

                    $('.btnDelete').on('click', (e) => {
                        e.preventDefault()

                        let el = $(e.target).parents('.key-content')
                        let id = parseInt(el.data('id'))

                        if (id && !isNaN(id)) {
                            fetch(`${bridgePath}/vip/delete`, {
                                method: 'PUT',
                                headers: { 'Content-Type' : 'application/json' },
                                body: JSON.stringify({ keyId : id, adminPassword : adminPassword })
                            })
                            .then(async(res) => {
                                if (res && res.status === 200) {
                                    el.remove()
                                } else {
                                    $('#keyInfo').html(`<span class="text-danger">Error after delete key ID: ${id} </span>`)
                                }
                            })
                        }
                    })
                })

                                  